<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width">
        <title>remote2020 - examiner</title>
        <link rel="stylesheet" href="sandbox.css">
        <link rel="stylesheet" href="graph.css">
    </head>
    <body style="background-color:#808080" onload="load_code()">  

		<div class="split left" id='lefty'>
                    <input type="text" id="receiver-id" title="Enter ID" size="8">
                    <button id="connect-button" onclick="do_connect()" style="border-radius:4px">

<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-link-45deg" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M4.715 6.542L3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.001 1.001 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
  <path d="M5.712 6.96l.167-.167a1.99 1.99 0 0 1 .896-.518 1.99 1.99 0 0 1 .518-.896l.167-.167A3.004 3.004 0 0 0 6 5.499c-.22.46-.316.963-.288 1.46z"/>
  <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 0 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 0 0-4.243-4.243L6.586 4.672z"/>
  <path d="M10 9.5a2.99 2.99 0 0 0 .288-1.46l-.167.167a1.99 1.99 0 0 1-.896.518 1.99 1.99 0 0 1-.518.896l-.167.167A3.004 3.004 0 0 0 10 9.501z"/>
</svg>

<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-person-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
  <path fill-rule="evenodd" d="M2 15v-1c0-1 1-4 6-4s6 3 6 4v1H2zm6-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
</svg>
                    Connect</button>

                <div id="my-id" style="font-weight: bold; display:inline-block;" title="my-id">ID:</div>
                <div id="status" style="font-weight: bold; display:inline-block;" title="status">Status:</div>
                <div id="status2" style="font-weight: bold; display:inline-block;" title="status2">Status2:</div>

                <br><br>
                <input type="button" id="btnE" onclick='set_mode("graph","adv");' class="button-tumbling_e">
                <input type="button" id="btnSetup" onclick='set_mode("adv","graph")' class="button-setup">

<p class="boxed" mode="both" id="keygroup">
<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-keyboard" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 5H2a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1zM2 4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H2z"/>
  <path d="M13 10.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm0-2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-5 0A.25.25 0 0 1 8.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 8 8.75v-.5zm2 0a.25.25 0 0 1 .25-.25h1.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-1.5a.25.25 0 0 1-.25-.25v-.5zm1 2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-5-2A.25.25 0 0 1 6.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 6 8.75v-.5zm-2 0A.25.25 0 0 1 4.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 4 8.75v-.5zm-2 0A.25.25 0 0 1 2.25 8h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 2 8.75v-.5zm11-2a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-2 0a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm-2 0A.25.25 0 0 1 9.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 9 6.75v-.5zm-2 0A.25.25 0 0 1 7.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 7 6.75v-.5zm-2 0A.25.25 0 0 1 5.25 6h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5A.25.25 0 0 1 5 6.75v-.5zm-3 0A.25.25 0 0 1 2.25 6h1.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-1.5A.25.25 0 0 1 2 6.75v-.5zm0 4a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5zm2 0a.25.25 0 0 1 .25-.25h5.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-5.5a.25.25 0 0 1-.25-.25v-.5z"/>
</svg>

Local Keys
<input type="checkbox" id="chkKeys">
</p>



<div class="boxed" mode="adv">
<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-box-arrow-in-right" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M8.146 11.354a.5.5 0 0 1 0-.708L10.793 8 8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0z"/>
  <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 1 8z"/>
  <path fill-rule="evenodd" d="M13.5 14.5A1.5 1.5 0 0 0 15 13V3a1.5 1.5 0 0 0-1.5-1.5h-8A1.5 1.5 0 0 0 4 3v1.5a.5.5 0 0 0 1 0V3a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5h-8A.5.5 0 0 1 5 13v-1.5a.5.5 0 0 0-1 0V13a1.5 1.5 0 0 0 1.5 1.5h8z"/>
</svg>
To Partner
                    <input mode="adv" type="checkbox" id="chkRemoteStair">
</div>

                <br mode="adv"><br mode="adv">
                    <span mode="adv" id="lblStair">Staircase (0)</span>
                    <input mode="adv" type="checkbox" id="chkStair" style="display:none;">
                    <button mode="adv" type="button" id="btnStairStart" onclick="do_stair_restart();">Restart</button>
                    <input mode="adv" type="checkbox" id="chkMOCS" style="display:none;">
                    <button mode="adv" type="button" id="btnMOCSStart" onclick="do_mocs_restart();">Restart MOCS</button>

                <button mode="adv" type="button" id="btnRun" onclick="do_trial();">RUN 1 Trial!</button>
                    <br mode="adv"><br mode="adv">

                <button mode="adv" type="button" id="demo1" onclick="demo1()">Tumbling-E (fovea)</button>
                <button mode="adv" type="button" id="demo1p" onclick="demo1p()">Tumbling-E (5deg)</button>

                <button mode="adv" type="button" id="mocs1" onclick="mocs1()">E MOCS (fovea)</button>
                <button mode="adv" type="button" id="mocs1p" onclick="mocs1p()">E MOCS (5deg)</button>

                <button mode="adv" type="button" id="demo2" onclick="demo2()">CSF</button>

                <table mode="graph" id="table_graph" style="width:100%;height:100px;border-top:1px" hidden=true>
                    <tr><td width="30pix"></td><td width="30pix"></td><td width=400 id='td_graph'><div id="my_dataviz" class="graph"></div></td></tr>
                </table>
                <table mode="graph" id="table_arrows" style="width:100px;height:200px;border-top:1px;margin-left:auto;margin-right:auto" hidden=true>
                    <tr><td width="30px"></td><td width="30px">UP<td><td width"30px"><tr>
                    <tr><td width="30px">LEFT</td><td width="30px"><td><td width"30px">RIGHT<tr>
                    <tr><td width="30px"></td><td width="30px">DOWN<td><td width"30px"><tr>
                </table>

                <textarea name="commands" id="commands" mode="adv" style="height:300px;width:90%">Trial code</textarea>
                <table mode="adv" style="width:100%;height:200px;border-top:1px">
                    <tr><td width=70%>
                    <textarea  name="trial" id="trial" style="width:100%;height:75%;">Trial parameters</textarea>
                    <textarea  name="metap" id="metap" style="width:100%;height:75%;">Meta parameters</textarea>
                        </td><td>
                    <button type="button" id="btnClearLog" onclick="clear_log();">Clear Log</button>
                    <button type="button" id="btnExport" onclick="navigator.clipboard.writeText(get_html('log'))">Copy</button>
                    <textarea name="log" id="log" style="width:90%;height:75%;">trial,size,ori,resp,correct,is_reversal,num_reversals</textarea>
                    </tr>
                </table>
		</div>

		<div class="split right" id="rightcan">
            <canvas id="canvas">Canvas</canvas>
		</div>

		<script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script src="loglevel.min.js"></script>
        <script src="drc-misc.js"></script>
        <script src="staircase.js"></script>
        <script src="stims.js"></script>
        <script src="mypeer.js" type="text/javascript"> </script>
        <script src="grating.js"></script>
        <script src="graph.js"></script>

        <script type="text/javascript">
            function clear_log() {
                set_html('log',"trial,size,ori,resp,correct,is_reversal,num_reversals");
            }

            var metap = []; // GLOBAL
            function get_metap() {
                // TODO: A callback when it changes instead?
                eval( document.getElementById("metap").value );
            }

            var queryDict = {} // GLOBAL
            function load_code() {
                peer_init();
                demo1(); // preload E acuity
                build_table(); // create graph table

                location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]})

                // Save default style for each. set_mode sets style to "none" to hide. Need this to restore
                var lefty=document.getElementById('lefty');
                [].forEach.call(lefty.children, a => {
                    a.old_display=a.style.display;
                });


                if (queryDict['mode']=='graph') {
                    set_mode("graph","adv");
                }
            };

            function peer_init() {
                var handler={
                    id: function(s) {set_html('my-id','My ID:'+s);},
                    lost: function(s) {set_html('status',s);},
                    error: function(s) {set_html('status',s);},
                    connect: function(s) {set_html('status','Pair:'+ s); set_checked("chkRemoteStair",true);},
                    peer_info: function(s) {set_html('status2','Scr:'+s);},
                    unpair: function (s) {set_html ('status',s);},
                    keyboard: function (nkey) {do_kb(nkey);},
                    receive: function (s) {},
                }
                thePeer=new MyPeer(handler);
                thePeer.init();
            };

            function do_connect() {
                thePeer.join(get_value('receiver-id'));
            };

            var thePeer = null; 

            function reportSize() {
                var rightcan = document.getElementById("rightcan");
                wid=rightcan.clientWidth;
                height=rightcan.clientHeight;
                canv.width=wid;
                canv.height=height;
                xc=wid/2;
                yc=height/2;

                //document.getElementById("pCanvasSize").innerHTML="Canvas Size: "+rightcan.scrollWidth+"x"+rightcan.scrollHeight;

                //canvas.className = "fullscreen"
                //document.body.scrollTop = 0; // <-- pull the page back up to the top
                //document.body.style.overflow = 'hidden'; // -- relevant addition
            }

			function table_button_click(which) {
			    var thisid='count_'+which;
				console.log(thisid);
				set_html(thisid,parseInt(get_html(thisid))+1);
                manual_trial(which);
			}

            function build_table() {
                var table=document.getElementById('table_graph');
                var td_graph=document.getElementById('td_graph');
                const nrows=15;
                td_graph.rowSpan=nrows+1;

                //tr.width="360px";
                for (var nrow = 0; nrow <= nrows-1; nrow++) {

                    tr = table.insertRow(-1);
                    var td = document.createElement('td');
                    td = tr.insertCell(0);
                    var button = document.createElement('input');
                    button.setAttribute('type', 'button');
                    button.setAttribute('value', nrows-nrow);
                    button.setAttribute('onclick', 'table_button_click('+(nrows-nrow)+')');
                    td.appendChild(button);

                    td = tr.insertCell(0);
                    td.id='count_'+(nrows-nrow);
                    td.innerHTML="0";
                }
                if (false) { // If on bottom, need this (horizontal-arranged stimuli)
                    tr = table.insertRow(-1);
                    for (var nrow = 0; nrow <= nrows- 1; nrow++) {
                        var td = document.createElement('td');
                        td = tr.insertCell(-1);
					    td.id='count_'+nrow;
					    td.innerHTML="0";
                    }
                }
            }

            function set_mode(show,hide) {
                //mode_setup=(mode_setup==false); // toggle
                // TODO: Determine if we already in a mode, otherwise
                // a.old_display gets blown away.. I guess
                // maybe could save that just once (in startup)

                if (true) {
                    var lefty=document.getElementById('lefty');
                    [].forEach.call(lefty.children, a => {
                        if (a.getAttribute("mode")==hide) {
                            a.hidden=true;
                            a.style.display="none";
                        } else if (a.getAttribute("mode")==show) {
                            a.hidden=false; // Needed for graph table and arrow 
                            a.style.display=a.old_display;
                        }
                    });
                } else {
                    ;
                };
            }

            // Global variables
            var c = document.getElementById("canvas");
            var canv = document.getElementById("canvas");
            var ctx = canv.getContext("2d");
            var wid=768
            var height=768;
            var xc=wid/2;
            var yc=height/2;
            var conn = null;

            var mode_setup="E";

            // Command/Action stuff
            var commands=null;
            var commands_split=null;
            var flip_durations=[];
            var actions=[];
            var globalAnimationID=null;
            var indexAction=0;
            var indexFrame=0;
            var trial_params={};

            var in_trial=false;

            // shader grating stuff:
            var gl, program; // these are used in grating_shader.
            // window.addEventListener("load", setupWebGL, false); //now we call explicit and swtich context

            //c = document.getElementById("canvas");
            //ctx = c.getContext("2d");

            function send_trial() {
                // get commands
                var commands=document.getElementById("commands").value;
                // Replace the meta parameters (since 1 string);
                trial_params=eval(document.getElementById("trial").value);
                commands=fillTemplate(commands,trial_params );
                var msg="T "+commands;
                if (thePeer && thePeer.conn && thePeer.conn.open) {
			        thePeer.send(msg);
                }
            }

            function do_trial() {
                if ( get_checked("chkRemoteStair")) {
                    send_trial(); 
                }

                //var chkFullScr = document.getElementById("chkFullScr");
                //if (chkFullScr.checked) {
                    //openFullscreen();
                //}

                // parse commands
                commands=document.getElementById("commands").value;

                // First replace the meta parameters (since 1 string)
                trial_params=eval(document.getElementById("trial").value);
                commands=fillTemplate(commands,trial_params )

                actions=commands.split("flip")
                flip_durations=[];
                for (i=1; i<actions.length; i++) {
                    // Assume the first number in each item (except the first) looks like: (60)\n;...next...
                    // Since the 'flip' was stripped out

                    dur=parseInt(actions[i].substr(1))
                    flip_durations.push(dur);

                    start_of_next_line=actions[i].indexOf(')');
                    actions[i]=actions[i].substr(start_of_next_line+1);
                }
                // remote last flip (empty action) if we need to.
                if (actions[i-1].length<2) {
                    actions.pop();
                }

                // Start the animation
                indexAction=0;
                indexFrame=0;
                in_trial=true;
                globalAnimationID = requestAnimationFrame(animateLoop);
            }

            function demo1() {
                document.getElementById("commands").value=
                "clear('#ffffff');\nfixation(0,0,20,4,'green');\nflip(30);\n\nclear('#ffffff');\n//beep(1,880,30);\nflip(1);\n\n\ndraw_letter('E',${orientation},0,0,${size},'black',-1,-1);\nflip(10)\t\/\/Draw for 10 frames (160ms);\n\nclear('#ffffff');\nfixation(0,0,20,4,'black');flip(1);"
                document.getElementById("trial").value="trial_params={\n\torientation: 0,\n\tsize:32\n}";
                document.getElementById("metap").value="metap={\n\tstaircase_reversals:[1.26,1.26,1.26,1.26,1.12,1.12,1.12,1.12],\n\tstair_start:32,\nmocs_spacings:[1.25,1.75,2,2.5,3,5,99],\n\tmocs_repeats:10}";
            }
            function mocs1() {
                document.getElementById("commands").value=
                "clear('#ffffff');\nfixation(0,0,20,4,'green');\nflip(30);\n\nclear('#ffffff');\n//beep(1,880,30);\nflip(1);\n\n\ndraw_letter('E',${orientation},0,0,10,'black',-1,${size});\nflip(10)\t\/\/Draw for 10 frames (160ms);\n\nclear('#ffffff');\nfixation(0,0,20,4,'black');flip(1);"
                document.getElementById("trial").value="trial_params={\n\torientation: 0,\n\tsize:32\n}";
                document.getElementById("metap").value="metap={\n\tstaircase_reversals:[1.26,1.26,1.26,1.26,1.12,1.12,1.12,1.12],\n\tstair_start:32,\nmocs_spacings:[1.25,1.75,2,2.5,3,5,99],\n\tmocs_repeats:10}";
            }

            function demo1p() {
                document.getElementById("commands").value=
                "clear('#ffffff');\nfixation(0,-700,20,4,'green');\nflip(30);\n\nclear('#ffffff');\n//beep(1,880,30);\nfixation(0,-700,20,4,'black');\nflip(1);\n\nfixation(0,-700,20,4,'black');\ndraw_letter('E',${orientation},0,333,${size},'black',-1,-1);\nflip(10)\t\/\/Draw for 10 frames (160ms);\n\nclear('#ffffff');\nfixation(0,-700,20,4,'black');flip(1);"
                document.getElementById("trial").value="trial_params={\n\torientation: 0,\n\tsize:72\n}";
                document.getElementById("metap").value="metap={\n\tstaircase_reversals:[1.26,1.26,1.26,1.26,1.12,1.12,1.12,1.12],\n\tstair_start:72,\nmocs_spacings:[1.25,1.75,2,2.5,3,5,99],\n\tmocs_repeats:10}";
            }


            function mocs1p() {
                document.getElementById("commands").value=
                "clear('#ffffff');\nfixation(0,-700,20,4,'green');\nflip(30);\n\nclear('#ffffff');\n//beep(1,880,30);\nfixation(0,-700,20,4,'black');\nflip(1);\n\nfixation(0,-700,20,4,'black');\ndraw_letter('E',${orientation},0,333,20,'black',-1,${size});\nflip(10)\t\/\/Draw for 10 frames (160ms);\n\nclear('#ffffff');\nfixation(0,-700,20,4,'black');flip(1);"
                document.getElementById("trial").value="trial_params={\n\torientation: 0,\n\tsize:72\n}";
                document.getElementById("metap").value="metap={\n\tstaircase_reversals:[1.26,1.26,1.26,1.26,1.12,1.12,1.12,1.12],\n\tstair_start:72,\nmocs_spacings:[1.25,1.75,2,2.5,3,5,99],\n\tmocs_repeats:10}";
            }

            function demo2() {
                //document.getElementById("commands").value=
                //"make_grating(20,2.0); clear('#c0c0c0');\nfixation(0,0,10,2,'green');\nflip(30);\nclear('#c0c0c0');\n//beep(1,880,30); flip(1); \
                //animate_grating();\nflip(100);\nclear('#c0c0c0');fixation(0,0,10,2,'black');flip(1);"

                // Clone the canvas to unhook the canvas
                var newCvs = c.cloneNode(false);
                c.parentNode.replaceChild(newCvs, c);
                c = newCvs;

                setupWebGL();
                showShaderGrating();
            }

            function animateLoop() {
                //var trial_params=document.getElementById("trial").value;
                if (indexAction<actions.length) {
                    //stats.begin()
                    //filled=fillTemplate(actions[indexAction],eval(trial_params) )
                    eval( actions[indexAction] );
                    //stats.end()
                    indexFrame += 1;
                    if (indexFrame>=flip_durations[indexAction]) {
                        indexFrame = 0;
                        indexAction += 1;
                    }

                    globalAnimationID = requestAnimationFrame(animateLoop);
                } else { // no more actions left
                    // reset, in case we want to run again
                    indexAction = 0;
                    indexFrame = 0;
                    cancelAnimationFrame(globalAnimationID);
                    in_trial=false;
                }
            }

		function openFullscreen() {

            if (document.fullscreenElement) {
                return;
            }

                  var elem = document.getElementById("canvas");
		  if (elem.requestFullscreen) {
		    elem.requestFullscreen();
		  } else if (elem.mozRequestFullScreen) { /* Firefox */
		    elem.mozRequestFullScreen();
		  } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
		    elem.webkitRequestFullscreen();
		  } else if (elem.msRequestFullscreen) { /* IE/Edge */
		    elem.msRequestFullscreen();
		  }
    		elem.width = document.body.clientWidth; //document.width is obsolete
    		elem.height = document.body.clientHeight; //document.height is obsolete

			s= elem.scrollWidth + ' ' + elem.scrollHeight + ' ' + elem.width + ' ' + elem.height;
			//conn.send(s);
		};

		function closeFullscreen() {
            try {
              /*if (document.exitFullscreen) {
                document.exitFullscreen();
              } else
                */
                
              if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
              } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                document.webkitExitFullscreen();
              } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
              } 
            } catch (error) {
                  //console.error(error);
                  console.log('Error: Exit Fullscr');
            }
		}

        // Main Javascript entry:
        reportSize();//call once to set initial size
        window.addEventListener('resize', reportSize);
        //audio=new AudioContext() // for beeping. browsers limit the number of concurrent audio contexts, so you better re-use'em

        //var stats = new Stats();
        //stats.showPanel( 1 ); // 0: fps, 1: ms, 2: mb, 3+: custom
        //stats.dom.style.position="absolute";
        //stats.dom.style.top="90%";
        //document.body.appendChild( stats.dom );

        var theStaircase=new staircase(8,3); // 3-up 1-down, default size of "8" (but hopefully never used)
        var theMOCS=new MOCS(); // 3-up 1-down, default size of "8" (but hopefully never used)

        function do_stair_restart() {
            set_checked('chkStair',true);
            set_checked('chkMOCS',false);
            set_html("lblStair","Staircase 0 0");

            get_metap(); // make sure to load in meta parameters TODO:fixme
            theStaircase.restart(parseInt(metap.stair_start));
            theStaircase.next(); // show first trial
        }

        function do_mocs_restart() {
            set_checked('chkStair',false);
            set_checked('chkMOCS',true);
            set_html("lblStair","MOCS X");

            get_metap(); // make sure to load in meta parameters TODO:fixme
            theMOCS.restart(metap.mocs_spacings,metap.mocs_repeats);
            theMOCS.next(); // show first trial
        }

        // Keyboard stuff:
        document.addEventListener('keydown', function(event) {key_handler(event);} );

        function key_handler(event) {
            if (get_checked("chkKeys") ) {
                do_kb(event.keyCode);
            }
        }

        function do_kb(keycode) {
            var ori_resp;
            switch (keycode) {
                case 37: //L
                    ori_resp=180; break;
                case 38: //U
                    ori_resp=90; break;
                case 39: //R
                    ori_resp=0; break;
                case 40: //D
                    ori_resp=270; break;
                default:
                    return; // do nothing if unrecognized key
                }

            if (get_checked("chkStair")) {
                var correct=(ori_resp==trial_params['orientation']);
                theStaircase.update(correct,ori_resp); // TODO: passing in ori_resp just for logging
                // TODO: return boolean for finished from update and do stuff here, instead of spaghetti
            }
            if (get_checked("chkMOCS")) {
                var correct=(ori_resp==trial_params['orientation']);
                theMOCS.update(correct,ori_resp); // TODO: passing in ori_resp just for logging
                // TODO: return boolean for finished from update and do stuff here, instead of spaghetti
            }
        };
</script>
    </body>
</html>

